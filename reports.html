<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>團購系統 - 銷售報表</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --soft-bg: #f8f9fa;
            --navbar-bg: #8ab6d6;
            --theme-color: #29b6f6;
            --theme-light: #e3f2fd;
        }
        body { background-color: var(--soft-bg); }
        .navbar-custom { background-color: var(--navbar-bg) !important; }
        
        .stat-card {
            border: none; border-radius: 15px; color: white; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); }

        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .filter-bar { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .table-custom thead th { background-color: var(--theme-light); color: #0277bd; border: none; }
        
        /* 頭像樣式 */
        .avatar-circle { width: 32px; height: 32px; background-color: #e0e0e0; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 0.8rem; color: #555; }
        
        /* 數量強調樣式 */
        .qty-highlight {
            font-family: 'Segoe UI', sans-serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-custom mb-4 shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="index.html"><i class="bi bi-shop-window me-2"></i>團購小幫手</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="products.html"><i class="bi bi-box2 me-1"></i>商品管理</a>
                <a class="nav-link" href="customers.html"><i class="bi bi-people me-1"></i>客戶管理</a>
                <a class="nav-link" href="orders.html"><i class="bi bi-cart-check me-1"></i>訂單管理</a>
                <a class="nav-link active" href="reports.html"><i class="bi bi-graph-up me-1"></i>銷售報表</a>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    
    <div class="filter-bar mb-4 d-flex flex-wrap align-items-center gap-3">
        <div class="d-flex align-items-center">
            <i class="bi bi-funnel-fill text-primary me-2"></i>
            <span class="fw-bold text-secondary">報表篩選：</span>
        </div>
        <div>
            <select id="filterMode" class="form-select form-select-sm border-primary">
                <option value="all">全部資料 (All Time)</option>
                <option value="month">指定月份 (Monthly)</option>
                <option value="range">自訂日期 (Custom Range)</option>
            </select>
        </div>
        <div id="monthPickerGroup" class="d-none">
            <input type="month" id="inputMonth" class="form-control form-control-sm">
        </div>
        <div id="rangePickerGroup" class="d-none d-flex gap-2 align-items-center">
            <input type="date" id="inputStart" class="form-control form-control-sm">
            <span class="text-muted">~</span>
            <input type="date" id="inputEnd" class="form-control form-control-sm">
        </div>
        <button id="btnQuery" class="btn btn-primary btn-sm px-3"><i class="bi bi-search"></i> 查詢</button>
        <button id="btnReset" class="btn btn-outline-secondary btn-sm" title="重新載入"><i class="bi bi-arrow-clockwise"></i></button>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card stat-card bg-gradient-primary h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">總銷售額 (Revenue)</h6>
                    <h2 class="fw-bold mb-0">$<span id="totalRevenue">0</span></h2>
                    <small class="opacity-75" id="dateLabel">統計範圍：全部</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card bg-gradient-success h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">預估總毛利 (Profit)</h6>
                    <h2 class="fw-bold mb-0">$<span id="totalProfit">0</span></h2>
                    <small class="opacity-75">銷售價 - 成本</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card bg-gradient-info h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">訂單數量 (Orders)</h6>
                    <h2 class="fw-bold mb-0"><span id="totalOrders">0</span></h2>
                    <small class="opacity-75">筆交易紀錄</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header text-primary bg-white">
                    <i class="bi bi-graph-up me-2"></i>銷售趨勢分析
                </div>
                <div class="card-body">
                    <div style="height: 300px;"><canvas id="trendChart"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header text-success bg-white">
                    <i class="bi bi-trophy me-2"></i>熱銷商品 TOP 5
                </div>
                <div class="card-body">
                    <div style="height: 300px;"><canvas id="topProdChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-5 border-info">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-search-heart text-info fs-4 me-2"></i>
                <h5 class="mb-0 fw-bold text-dark">單一商品買家追蹤</h5>
            </div>
            <div class="w-50">
                <select id="selectProductDetail" class="form-select border-info">
                    <option value="">請選擇要查詢的商品...</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="productDetailInfo" class="text-center text-muted py-5">
                <i class="bi bi-basket display-4 d-block mb-3 opacity-25"></i>
                請從右上方選擇商品，即可查看誰買了這個東西
            </div>
            
            <div id="productDetailTableContainer" class="d-none">
                <div class="d-flex justify-content-between mb-3 px-2">
                    <span class="text-muted">總銷量: <strong class="text-danger fs-4" id="detailTotalQty">0</strong></span>
                    <span class="text-muted">購買人數: <strong class="text-dark fs-5" id="detailTotalPeople">0</strong></span>
                </div>
                <table class="table table-hover table-custom align-middle">
                    <thead>
                        <tr>
                            <th>買家姓名</th>
                            <th class="text-center">購買數量</th>
                            <th class="text-center">最後購買日</th>
                            <th class="text-end">累計金額</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let rawOrders = [];
    let productsCostMap = {}; 
    let productsNameList = [];
    let chartInstanceTrend = null;
    let chartInstanceTop = null;

    const filterMode = document.getElementById('filterMode');
    const monthPicker = document.getElementById('monthPickerGroup');
    const rangePicker = document.getElementById('rangePickerGroup');
    const inputMonth = document.getElementById('inputMonth');
    const inputStart = document.getElementById('inputStart');
    const inputEnd = document.getElementById('inputEnd');
    const dateLabel = document.getElementById('dateLabel');
    
    const selectProductDetail = document.getElementById('selectProductDetail');
    const productDetailInfo = document.getElementById('productDetailInfo');
    const productDetailTableContainer = document.getElementById('productDetailTableContainer');
    const detailTableBody = document.getElementById('detailTableBody');
    const detailTotalQty = document.getElementById('detailTotalQty');
    const detailTotalPeople = document.getElementById('detailTotalPeople');

    async function initData() {
        const prodSnap = await getDocs(collection(db, "products"));
        productsNameList = [];
        
        prodSnap.forEach(doc => {
            const data = doc.data();
            productsCostMap[doc.id] = data.cost || 0;
            productsNameList.push({ id: doc.id, name: data.name });
        });

        productsNameList.forEach(p => {
            selectProductDetail.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });

        const orderSnap = await getDocs(query(collection(db, "orders"), orderBy("orderDate", "asc")));
        rawOrders = orderSnap.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            dateObj: doc.data().orderDate.toDate()
        }));

        updateDashboard(rawOrders);
    }

    filterMode.addEventListener('change', () => {
        const mode = filterMode.value;
        monthPicker.classList.add('d-none');
        rangePicker.classList.add('d-none');
        if (mode === 'month') {
            monthPicker.classList.remove('d-none');
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            if(!inputMonth.value) inputMonth.value = `${y}-${m}`;
        } else if (mode === 'range') rangePicker.classList.remove('d-none');
    });

    document.getElementById('btnQuery').addEventListener('click', performQuery);
    document.getElementById('btnReset').addEventListener('click', () => {
        filterMode.value = 'all';
        filterMode.dispatchEvent(new Event('change'));
        updateDashboard(rawOrders);
    });

    function performQuery() {
        const mode = filterMode.value;
        let filtered = [];
        let labelText = "";

        if (mode === 'all') {
            filtered = rawOrders;
            labelText = "統計範圍：全部資料";
        } else if (mode === 'month') {
            const val = inputMonth.value;
            if (!val) { alert("請選擇月份"); return; }
            const [year, month] = val.split('-');
            filtered = rawOrders.filter(o => o.dateObj.getFullYear() == year && (o.dateObj.getMonth() + 1) == month);
            labelText = `統計範圍：${year}年 ${month}月`;
        } else if (mode === 'range') {
            const s = inputStart.value;
            const e = inputEnd.value;
            if (!s || !e) { alert("請選擇開始與結束日期"); return; }
            const startDate = new Date(s + "T00:00:00");
            const endDate = new Date(e + "T23:59:59");
            filtered = rawOrders.filter(o => o.dateObj >= startDate && o.dateObj <= endDate);
            labelText = `統計範圍：${s} ~ ${e}`;
        }
        dateLabel.innerText = labelText;
        updateDashboard(filtered);
    }

    function updateDashboard(orders) {
        let totalRevenue = 0, totalProfit = 0, productSales = {}, trendData = {};

        orders.forEach(order => {
            totalRevenue += order.totalAmount;
            let orderCost = 0;
            if(order.items) {
                order.items.forEach(item => {
                    const cost = productsCostMap[item.id] || 0;
                    orderCost += cost * item.qty;
                    productSales[item.name] = (productSales[item.name] || 0) + item.qty;
                });
            }
            totalProfit += (order.totalAmount - orderCost);

            const d = order.dateObj;
            const mode = filterMode.value;
            const key = (mode === 'all') ? `${d.getFullYear()}/${d.getMonth()+1}` : `${d.getMonth()+1}/${d.getDate()}`;
            
            if(!trendData[key]) trendData[key] = 0;
            trendData[key] += order.totalAmount;
        });

        document.getElementById('totalRevenue').innerText = totalRevenue.toLocaleString();
        document.getElementById('totalProfit').innerText = totalProfit.toLocaleString();
        document.getElementById('totalOrders').innerText = orders.length;

        renderCharts(trendData, productSales);
    }

    function renderCharts(trendData, productSales) {
        if (chartInstanceTrend) chartInstanceTrend.destroy();
        if (chartInstanceTop) chartInstanceTop.destroy();

        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        const sortedKeys = Object.keys(trendData).sort((a,b) => new Date(a.replace('/','-')) - new Date(b.replace('/','-')));

        chartInstanceTrend = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: Object.keys(trendData),
                datasets: [{
                    label: '營收 ($)',
                    data: Object.values(trendData),
                    borderColor: '#29b6f6',
                    backgroundColor: 'rgba(41, 182, 246, 0.1)',
                    tension: 0.3, fill: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        const ctxTop = document.getElementById('topProdChart').getContext('2d');
        const sortedProds = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);

        chartInstanceTop = new Chart(ctxTop, {
            type: 'bar',
            data: {
                labels: sortedProds.map(i => i[0]),
                datasets: [{
                    label: '數量',
                    data: sortedProds.map(i => i[1]),
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
        });
    }

    // 4. 單一商品買家追蹤邏輯
    selectProductDetail.addEventListener('change', () => {
        const prodId = selectProductDetail.value;
        if (!prodId) {
            productDetailInfo.classList.remove('d-none');
            productDetailTableContainer.classList.add('d-none');
            return;
        }

        const buyersMap = {}; 
        let grandTotalQty = 0;

        rawOrders.forEach(order => {
            if(!order.items) return;
            const targetItem = order.items.find(i => i.id === prodId);
            
            if(targetItem) {
                const cName = order.customerName;
                const qty = targetItem.qty;
                const amount = targetItem.price * qty;

                if(!buyersMap[cName]) {
                    buyersMap[cName] = { qty: 0, lastDate: order.dateObj, totalSpent: 0 };
                }
                buyersMap[cName].qty += qty;
                buyersMap[cName].totalSpent += amount;
                if (order.dateObj > buyersMap[cName].lastDate) {
                    buyersMap[cName].lastDate = order.dateObj;
                }
                grandTotalQty += qty;
            }
        });

        const buyersArray = Object.entries(buyersMap).map(([name, data]) => ({ name, ...data }));
        buyersArray.sort((a, b) => b.qty - a.qty);

        renderDetailTable(buyersArray, grandTotalQty);
    });

    function renderDetailTable(data, totalQty) {
        productDetailInfo.classList.add('d-none');
        productDetailTableContainer.classList.remove('d-none');
        
        detailTotalQty.innerText = totalQty;
        detailTotalPeople.innerText = data.length;
        detailTableBody.innerHTML = '';

        if(data.length === 0) {
            detailTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">尚未有銷售紀錄</td></tr>';
            return;
        }

        data.forEach(buyer => {
            const dateStr = buyer.lastDate.toLocaleDateString();
            const avatarLetter = buyer.name.charAt(0);
            
            detailTableBody.innerHTML += `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="avatar-circle">${avatarLetter}</span>
                            <span class="fw-bold fs-5">${buyer.name}</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="fs-3 fw-bolder text-primary qty-highlight">${buyer.qty}</span>
                    </td>
                    <td class="text-center text-muted small">${dateStr}</td>
                    <td class="text-end fw-medium">$${buyer.totalSpent}</td>
                </tr>
            `;
        });
    }

    initData();

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>