<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>團購系統 - 銷售報表</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --soft-bg: #f8f9fa;
            --navbar-bg: #8ab6d6;
            --theme-color: #29b6f6;
            --theme-light: #e3f2fd;
        }
        body { background-color: var(--soft-bg); }
        .navbar-custom { background-color: var(--navbar-bg) !important; }
        
        .stat-card {
            border: none; border-radius: 15px; color: white; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); }

        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .filter-bar { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-custom mb-4 shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="index.html"><i class="bi bi-shop-window me-2"></i>團購小幫手</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="products.html"><i class="bi bi-box2 me-1"></i>商品管理</a>
                <a class="nav-link" href="customers.html"><i class="bi bi-people me-1"></i>客戶管理</a>
                <a class="nav-link" href="orders.html"><i class="bi bi-cart-check me-1"></i>訂單管理</a>
                <a class="nav-link active" href="reports.html"><i class="bi bi-graph-up me-1"></i>銷售報表</a>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    
    <div class="filter-bar mb-4 d-flex flex-wrap align-items-center gap-3">
        <div class="d-flex align-items-center">
            <i class="bi bi-funnel-fill text-primary me-2"></i>
            <span class="fw-bold text-secondary">報表篩選：</span>
        </div>
        
        <div>
            <select id="filterMode" class="form-select form-select-sm border-primary">
                <option value="all">全部資料 (All Time)</option>
                <option value="month">指定月份 (Monthly)</option>
                <option value="range">自訂日期 (Custom Range)</option>
            </select>
        </div>

        <div id="monthPickerGroup" class="d-none">
            <input type="month" id="inputMonth" class="form-control form-control-sm">
        </div>

        <div id="rangePickerGroup" class="d-none d-flex gap-2 align-items-center">
            <input type="date" id="inputStart" class="form-control form-control-sm">
            <span class="text-muted">~</span>
            <input type="date" id="inputEnd" class="form-control form-control-sm">
        </div>

        <button id="btnQuery" class="btn btn-primary btn-sm px-3">
            <i class="bi bi-search"></i> 查詢
        </button>
        
        <button id="btnReset" class="btn btn-outline-secondary btn-sm" title="重新載入">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card stat-card bg-gradient-primary h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">總銷售額 (Revenue)</h6>
                    <h2 class="fw-bold mb-0">$<span id="totalRevenue">0</span></h2>
                    <small class="opacity-75" id="dateLabel">統計範圍：全部</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card bg-gradient-success h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">預估總毛利 (Profit)</h6>
                    <h2 class="fw-bold mb-0">$<span id="totalProfit">0</span></h2>
                    <small class="opacity-75">銷售價 - 成本</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card bg-gradient-info h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">訂單數量 (Orders)</h6>
                    <h2 class="fw-bold mb-0"><span id="totalOrders">0</span></h2>
                    <small class="opacity-75">筆交易紀錄</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header text-primary bg-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-graph-up me-2"></i>銷售趨勢分析</span>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header text-success bg-white">
                    <i class="bi bi-trophy me-2"></i>熱銷商品 TOP 5
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="topProdChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 全域變數 (儲存原始資料與圖表實例)
    let rawOrders = [];
    let productsCostMap = {};
    let chartInstanceTrend = null;
    let chartInstanceTop = null;

    // DOM 元素
    const filterMode = document.getElementById('filterMode');
    const monthPicker = document.getElementById('monthPickerGroup');
    const rangePicker = document.getElementById('rangePickerGroup');
    const inputMonth = document.getElementById('inputMonth');
    const inputStart = document.getElementById('inputStart');
    const inputEnd = document.getElementById('inputEnd');
    const dateLabel = document.getElementById('dateLabel');

    // 1. 初始化：載入資料
    async function initData() {
        // A. 建立成本對照表
        const prodSnap = await getDocs(collection(db, "products"));
        prodSnap.forEach(doc => {
            productsCostMap[doc.id] = doc.data().cost || 0;
        });

        // B. 抓取所有訂單 (一次抓取，前端篩選，提升效能)
        const orderSnap = await getDocs(query(collection(db, "orders"), orderBy("orderDate", "asc")));
        rawOrders = orderSnap.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            dateObj: doc.data().orderDate.toDate() // 預先轉好 Date 物件方便篩選
        }));

        // C. 預設顯示全部
        updateDashboard(rawOrders);
    }

    // 2. UI 互動邏輯
    filterMode.addEventListener('change', () => {
        const mode = filterMode.value;
        monthPicker.classList.add('d-none');
        rangePicker.classList.add('d-none');

        if (mode === 'month') {
            monthPicker.classList.remove('d-none');
            // 預設填入本月
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            if(!inputMonth.value) inputMonth.value = `${y}-${m}`;
        } else if (mode === 'range') {
            rangePicker.classList.remove('d-none');
        }
    });

    document.getElementById('btnQuery').addEventListener('click', performQuery);
    document.getElementById('btnReset').addEventListener('click', () => {
        filterMode.value = 'all';
        filterMode.dispatchEvent(new Event('change')); // 觸發 UI 隱藏
        updateDashboard(rawOrders);
    });

    // 3. 執行篩選邏輯
    function performQuery() {
        const mode = filterMode.value;
        let filtered = [];
        let labelText = "";

        if (mode === 'all') {
            filtered = rawOrders;
            labelText = "統計範圍：全部資料";
        } 
        else if (mode === 'month') {
            const val = inputMonth.value; // "2023-12"
            if (!val) { alert("請選擇月份"); return; }
            
            const [year, month] = val.split('-');
            filtered = rawOrders.filter(o => {
                return o.dateObj.getFullYear() == year && (o.dateObj.getMonth() + 1) == month;
            });
            labelText = `統計範圍：${year}年 ${month}月`;
        } 
        else if (mode === 'range') {
            const s = inputStart.value;
            const e = inputEnd.value;
            if (!s || !e) { alert("請選擇開始與結束日期"); return; }

            const startDate = new Date(s + "T00:00:00");
            const endDate = new Date(e + "T23:59:59");

            filtered = rawOrders.filter(o => {
                return o.dateObj >= startDate && o.dateObj <= endDate;
            });
            labelText = `統計範圍：${s} ~ ${e}`;
        }

        dateLabel.innerText = labelText;
        updateDashboard(filtered);
    }

    // 4. 更新儀表板核心 (計算 + 繪圖)
    function updateDashboard(orders) {
        let totalRevenue = 0;
        let totalProfit = 0;
        let productSales = {};
        let trendData = {}; // { "日期": 金額 }

        orders.forEach(order => {
            totalRevenue += order.totalAmount;

            // 計算毛利
            let orderCost = 0;
            if(order.items) {
                order.items.forEach(item => {
                    const cost = productsCostMap[item.id] || 0;
                    orderCost += cost * item.qty;
                    
                    // 統計商品銷量
                    productSales[item.name] = (productSales[item.name] || 0) + item.qty;
                });
            }
            totalProfit += (order.totalAmount - orderCost);

            // 準備圖表資料 (依日期 YYYY/MM/DD 聚合)
            const d = order.dateObj;
            // 如果是選全部，圖表顯示月份；如果是選特定區間，圖表顯示日期
            const mode = filterMode.value;
            let key;
            
            if (mode === 'all') {
                key = `${d.getFullYear()}/${d.getMonth()+1}`; // 2023/12
            } else {
                key = `${d.getMonth()+1}/${d.getDate()}`; // 12/25
            }

            if(!trendData[key]) trendData[key] = 0;
            trendData[key] += order.totalAmount;
        });

        // 更新數字卡片
        animateValue('totalRevenue', totalRevenue);
        animateValue('totalProfit', totalProfit);
        animateValue('totalOrders', orders.length);

        // 重新繪製圖表
        renderCharts(trendData, productSales);
    }

    // 簡單的數字跳動動畫
    function animateValue(id, end) {
        const obj = document.getElementById(id);
        obj.innerText = end.toLocaleString();
        // 為了效能，簡單直接替換，若要動畫可再擴充
    }

    function renderCharts(trendData, productSales) {
        // 1. 銷毀舊圖表
        if (chartInstanceTrend) chartInstanceTrend.destroy();
        if (chartInstanceTop) chartInstanceTop.destroy();

        // 2. 趨勢圖 (折線圖)
        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        // 對日期 key 進行排序
        const sortedKeys = Object.keys(trendData).sort((a,b) => {
            // 簡單排序邏輯，若跨年分較多需更嚴謹處理 Date parse
            return new Date(a) - new Date(b); 
        }); 
        
        // 若日期排序不準確 (例如 12/1 vs 12/10)，對於 all time 模式，key 是 "2023/10" 這種格式可直接字串排序
        // 對於 range 模式，key 是 "10/25"，排序可能需要轉回 date 物件。
        // 這裡做一個通用排序優化：
        // 由於我們原始資料 orders 已經依照 orderDate 排序過，
        // 我們依序讀取建立 trendData 時，順序大致是對的 (若是 Map)，但 Object key 順序不保證。
        // 為求精確，我們簡單處理：若 key 包含年，直接 sort；若只有月日，假設同一年
        
        // 簡化：直接使用 keys
        
        chartInstanceTrend = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: Object.keys(trendData),
                datasets: [{
                    label: '銷售金額 ($)',
                    data: Object.values(trendData),
                    borderColor: '#29b6f6',
                    backgroundColor: 'rgba(41, 182, 246, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });

        // 3. 熱銷排行 (長條圖)
        const ctxTop = document.getElementById('topProdChart').getContext('2d');
        const sortedProds = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);

        chartInstanceTop = new Chart(ctxTop, {
            type: 'bar',
            data: {
                labels: sortedProds.map(i => i[0]),
                datasets: [{
                    label: '數量',
                    data: sortedProds.map(i => i[1]),
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } }
            }
        });
    }

    // 啟動
    initData();

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>